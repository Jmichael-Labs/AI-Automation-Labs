# AI Education System - Production Ready
name: AI Education System - 4 Telegram Channel Automation

on:
  workflow_dispatch:
  push:

jobs:
  emergency-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
    - name: üö® Emergency Fresh Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        clean: true
        
    - name: ‚úÖ Verify Latest Commit
      run: |
        echo "üìä Current commit: $(git rev-parse --short HEAD)"
        echo "üìä Latest commits:"
        git log --oneline -3
        echo "‚úÖ Using latest code from main branch"
        
    - name: üß® Nuclear Cache Clear
      run: |
        echo "üí£ Clearing ALL cache locations..."
        rm -rf ~/.cache ~/.npm ~/.yarn ~/.cargo ~/.pip
        echo "üóëÔ∏è Cache annihilated"
        
    - name: üêç Setup Python (No Cache)
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: üì¶ Install Dependencies (Force Fresh)
      run: |
        echo "üì¶ Installing with --no-cache-dir..."
        python -m pip install --upgrade pip --no-cache-dir
        pip install --no-cache-dir -r requirements.txt
        echo "‚úÖ Fresh install complete"
        
    - name: ‚òÅÔ∏è Configure Google Cloud
      env:
        GOOGLE_APPLICATION_CREDENTIALS_JSON: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}
      run: |
        echo "$GOOGLE_APPLICATION_CREDENTIALS_JSON" > /tmp/gcp-key.json
        export GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json
        echo "GOOGLE_APPLICATION_CREDENTIALS=/tmp/gcp-key.json" >> $GITHUB_ENV
        
    - name: üéØ EMERGENCY AI EDUCATION SYSTEM
      env:
        # === TELEGRAM TOKENS ===
        TELEGRAM_LEGAL_TOKEN: ${{ secrets.TELEGRAM_LEGAL_TOKEN }}
        TELEGRAM_MEDICAL_TOKEN: ${{ secrets.TELEGRAM_MEDICAL_TOKEN }}
        TELEGRAM_SENIOR_TOKEN: ${{ secrets.TELEGRAM_SENIOR_TOKEN }}
        TELEGRAM_GENERAL_TOKEN: ${{ secrets.TELEGRAM_GENERAL_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        
        # === GUMROAD ===
        GUMROAD_API_KEY: ${{ secrets.GUMROAD_API_KEY }}
        GUMROAD_LEGAL_ID: ${{ secrets.GUMROAD_LEGAL_ID }}
        GUMROAD_MEDICAL_ID: ${{ secrets.GUMROAD_MEDICAL_ID }}
        GUMROAD_SENIOR_ID: ${{ secrets.GUMROAD_SENIOR_ID }}
        GUMROAD_GENERAL_ID: ${{ secrets.GUMROAD_GENERAL_ID }}
        
        # === KO-FI === (REMOVED - API doesn't support posting content)
        
        # === GOOGLE CLOUD ===
        GOOGLE_APPLICATION_CREDENTIALS: /tmp/gcp-key.json
        GOOGLE_PROJECT_ID: ${{ secrets.GOOGLE_PROJECT_ID }}
        
        # === CONTACT ===
        EMAIL_CONTACT: ${{ secrets.EMAIL_CONTACT }}
        INSTAGRAM_CONSULTING: ${{ secrets.INSTAGRAM_CONSULTING }}
        
      run: |
        echo "üö® EMERGENCY EXECUTION WITH CORRECT COMMIT"
        echo "üìÖ Time: $(date)"
        echo "üìä Commit: $(git rev-parse --short HEAD)"
        echo "üîç Files in directory:"
        ls -la multi_platform_engine.py
        
        echo "üîç Checking channel configuration:"
        grep -A 5 -B 5 "@AIEducationHub_bot" multi_platform_engine.py || echo "‚ùå Channel not found in code!"
        
        echo "üöÄ EXECUTING WITH FIXED CHANNELS..."
        python multi_platform_engine.py
        
    - name: üßπ Emergency Cleanup
      if: always()
      run: |
        rm -f /tmp/gcp-key.json
        echo "üßπ Emergency cleanup done"